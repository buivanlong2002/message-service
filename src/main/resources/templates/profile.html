<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang cá nhân</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #message {
            color: red;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<h2>Thông tin cá nhân</h2>

<div id="userInfo" style="display: none;">
    <p><strong>Họ tên:</strong> <span id="name"></span></p>
    <p><strong>Email:</strong> <span id="email"></span></p>
    <p><strong>ID:</strong> <span id="id"></span></p>
</div>

<div id="message"></div>

<button id="logoutBtn">Đăng xuất</button>

<script>
    $(document).ready(function () {
        const token = localStorage.getItem('access_token');

        if (!token) {
            $('#message').text("Bạn chưa đăng nhập hoặc token đã hết hạn.");
            return;
        }

        let payload;
        try {
            payload = JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            $('#message').text("Token không hợp lệ. Vui lòng đăng nhập lại.");
            localStorage.removeItem('access_token');
            return;
        }

        const userId = payload.id || payload.sub || payload.user_id; // fallback nếu backend dùng tên khác

        console.log(userId)

        $.ajax({
            url: `/api/auth/${userId}`,
            type: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function (response) {
                if (response.status?.code === "00" && response.status.success) {
                    const user = response.data;
                    $('#name').text(user.name || user.username);
                    $('#email').text(user.email);
                    $('#id').text(user.id);
                    $('#userInfo').show();
                } else {
                    $('#message').text("Không thể lấy thông tin người dùng.");
                }
            },
            error: function (xhr) {
                let errorMsg = "Lỗi khi lấy thông tin người dùng.";
                if (xhr.status === 401) {
                    errorMsg = "Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.";
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = '/login', 1500);
                } else if (xhr.responseJSON?.status?.displayMessage) {
                    errorMsg = xhr.responseJSON.status.displayMessage;
                }
                $('#message').text(errorMsg);
            }
        });

        $('#logoutBtn').click(function () {
            localStorage.removeItem('access_token');
            window.location.href = '/api/login';
        });
    });
</script>
</body>
</html>
